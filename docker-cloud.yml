nginx:
  image: nginx:stable
  environment:
    - API_SERVER_NAME
    - API_SSL_CERTIFICATE: /ssl/server.cert
    - API_SSL_CERTIFICATE_KEY: /ssl/server.key
  links:
    - hugo
    - kansa
  ports:
    - "80:80"
    - "443:443"
  volumes:
    - /opt/data/nginx/conf.template:/nginx.conf.template:ro
    - /opt/data/nginx/ssl:/ssl:ro
    - /opt/data/nginx/kansa/admin/dist:/usr/share/nginx/html/kansa/admin:ro
  command: /bin/bash -c "envsubst '$$API_SERVER_NAME $$API_SSL_CERTIFICATE $$API_SSL_CERTIFICATE_KEY' < /nginx.conf.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
  restart: always
  deployment_strategy: high_availability
  autoredeploy: true
  tags:
    - production

hugo:
  image: worldcon75/api-hugo
  environment:
    - CORS_ORIGIN
    - DATABASE_URL
    - SESSION_SECRET
  entrypoint: ./wait-for-it.sh postgres:5432 -- npm start
  links:
    - postgres
  expose:
    - "3000"
  restart: always
  deployment_strategy: high_availability
  autoredeploy: true
  tags:
    - production

kansa:
  image: worldcon75/api-kansa-server
  environment:
    - API_ROOT
    - CORS_ORIGIN
    - DATABASE_URL
    - SESSION_SECRET
    - SENDGRID_APIKEY
  entrypoint: ./wait-for-it.sh postgres:5432 -- npm start
  links:
    - postgres
  expose:
    - "3000"
  restart: always
  deployment_strategy: high_availability
  autoredeploy: true
  tags:
    - production

postgres:
  image: postgres:9.5
  environment:
    - PGDATA
    - POSTGRES_DB
    - POSTGRES_USER
    - POSTGRES_PASSWORD
    - KANSA_PG_PASSWORD
    - HUGO_PG_PASSWORD
  expose:
    - "5432"
  restart: always
  deployment_strategy: high_availability
  autoredeploy: true
  tags:
    - production
  volumes_from:
    - postgres-data

postgres-data:
  image: postgres:9.5
  environment:
    - PGDATA
    - POSTGRES_DB
    - POSTGRES_USER
    - POSTGRES_PASSWORD
    - KANSA_PG_PASSWORD
    - HUGO_PG_PASSWORD
  tags:
    - production
  volumes:
    - /opt/data/postgres-data:/pgdata
    - /opt/data/postgres-damm:/damm:ro
    - /opt/data/postgres-init:/docker-entrypoint-initdb.d:ro
